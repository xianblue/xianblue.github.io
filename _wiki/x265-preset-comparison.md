---
layout  : wiki
title   : x265 프리셋 비교
summary :
date    : 2021-07-03 16:13:38 +0900
updated : 2021-07-06 11:19:58 +0900
tags    : x265
toc     : true
public  : true
parent  : [[codec]]
latex   : false
---
* TOC
{:toc}

** 2021-07-06 테스트를 잘못한 것을 발견했습니다. 참고하지 말아주세요. **

## 개요
x265로 HEVC 인코딩을 할 경우, 프리셋(preset)으로 압축 정도를 정하고, CRF 값으로 화질을 정할 수 있다.

즉 동일 CRF, 다른 프리셋이면, 압축 정도에 따라 용량의 차이가 있을 뿐 동등한 화질을 보일 것으로 기대된다. 하지만 직접 인코딩해 보면 동일 CRF에서 프리셋 slow가 medium보다 더 큰 용량을 보이는 것을 확인 할 수 있었다. 더 압축되었을 프리셋의 용량이 크다는 것은, CRF가 같다고 하더라도 프리셋에 따라 화질 차이가 보일 것으로 생각된다.


[//]: # 더 찾아보니, x265에서는 다른 프리셋에서도 더 압축되는 프리셋일 경우 더 큰 파일을 생성한다는 것을 알 수 있었다 [#](https://write.corbpie.com/ffmpeg-preset-comparison-x265-2019-encode-speed-and-file-size/).

[//]: # x265 기본 프리셋은 medium인데, slow로 인코딩하는 것이 인코딩 속도와 용량 면에서 괜찮은 트레이드 오프라 흔히 생각되는 것 같다.

프리셋 slow의 CRF값 x가 프리셋 medium의 어떤 CRF 값에 대응되는지, 시간을 더 들여 slow 로 인코딩하는 것이 더 괜찮은 선택인지 궁금해, 각 프리셋에서 여러 CRF 값으로 인코딩 후 화질을 비교해봤다.

또한 x264에서는 원본 영상이 8bit 영상이어도, 10bit로 인코딩하는 것이 더 유리하다는 이야기가 있었는데, x265에서도 그러한지 비교해보았다. 마지막으로 x264의 veryslow 프리셋 대비 화질도 비교해보았다.

## 화질 측정
1080p, 8bit의 샘플 영상을 다음과 같이 인코딩한 후, 원본 대비 품질을 계산하였다.
* x264 veryslow 프리셋의 CRF 18부터 29까지
* x265 slow 프리셋의 CRF **19**부터 30까지
* x265 medium 프리셋의 CRF 18부터 29까지
* 10bit로 변환 후 x265의 main10 프로파일, medium 프리셋의 CRF 18부터 29까지

화질 측정은 ffmpeg를 이용하였는데, ffmpeg가 지원하는 SSIM·PSNR·VMAF를 계산하는 것으로 했다. 각 지표는 다음을 의미한다.
* PSNR: 신호 대 잡음 비 (원 영상과 얼마나 차이가 나는지 측정하는 값)
* SSIM: 구조적 유사도
* VMAF: Netflix가 개발한 화질 지표

사용한 프로그램의 버전은 다음과 같다.
* x264: 161 r3039 544c61f
* x265: 3.5
* ffmpeg: 4.4

## 결과
계산한 결과는 다음과 같다. 가로축이 인코딩 후 파일 크기, 세로축이 각 계산치이다. 왼쪽·위쪽으로 갈수록 용량대비 화질이 뛰어나다는 의미이다.
![image](/assets/img/2021-07-03-psnr3.png)
![image](/assets/img/2021-07-03-ssim3.png)
![image](/assets/img/2021-07-03-vmaf3.png)

## 결론
* 화질 기준에서 프리셋 slow 와 medium의 관계는 다음과 같다.
  - slow 프리셋 CRF 𝛼-1 ⪆ medium 프리셋 CRF 𝛼
* x265 프리셋 medium이 slow보다 PSNR 기준 우월하다. 결과가 납득이 안 돼서 다른 영상으로 하나 더 테스트해보아도 이처럼 나왔다.
* x265로 인코딩하는 경우, 8bit 영상을 10bit로 변환해 저장하는 것은 아무런 의미가 없다.
* x265 프리셋 slow가 medium보다 동일 화질에서 대충 5% 정도 효율적이다. (VMAF 기준)
* 내 기준에서는 시간을 2배 가까이 사용하면서 slow 프리셋을 사용할 이유가 없어 보인다. medium으로도 충분한 것 같다.
